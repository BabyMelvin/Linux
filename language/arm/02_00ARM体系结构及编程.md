# 1.ARM体系结构
体系结构：硬件和软件资源以及相互间的连接关系。

体系结构最重要是：**指令系统**和**寄存器组**。
* 指令系统分为：CISC和RISC，嵌入式CPU使用RISC结构。

体系结构还有存储器结构：冯.诺依曼结构和哈佛结构

* 冯.诺依曼结构：传统计算机，将指令存储器和数据存储器合并在一起。
	* 特点：程序和数据共用一个存储空间。处理器执行指令必须从存储器取出指令解码，再取数据运算，高速运算容易产生瓶颈。
* 哈佛结构：将程序存储和数据存储分开，一种并行系统结构。
	* 特点：有两个独立存储器(指令和数据)，可独立编址和独立访问。有4条总线(数据的地址总线和数据总线，程序的地址总线和数据总线)

# 2.ARM流程线结构
处理器执行每一条指令的典型步骤：

* 1.从存储器读取指令(fetch)
* 2.译码以鉴别它是哪一类指令(dec)
* 3.从寄存器组取得所有需要的操作数(reg)
* 4.将操作数据进行组合以得到结果或存储器地址(exe);
* 5.如果需要，则访问存储器存取数据(mem)
* 6.将结构会写到寄存器组(res)

上面步骤操作都是独立的。

ARM7采用三级流水线：取指、译码和执行。采用冯结构，指令和数据不能再用一个周期进行操作。

ARM9采用的是5级流水线结构，内部使用哈佛结构（拥有独立的指令和数据总线）。指令和数据的读取可以在同一周期进行。

# 3.ARM总线结构
ARM使用的是AMBA总线结构，用来连接高性能系统模块，支持突发方式数据传输。AMBA是ARM公司公布的总线标准，有3种总线：

* AHB(Adanced High performance Bus)：连接高性能系统模块，支持突发式数据传输方式及单个数据传输方式，所有参考同一个时钟沿。
* ASB（Advanced System Bus):用于高性能系统模块，支持突发数据传输模式。
* APB（Advaned Peripheral Bus)：一个简单接口支持低性能的外围接口。

# 4.ARM微处理器的工作状态和模式
## 4.1工作状态
有两种状态：

* 1.ARM状态：处理器执行32位对齐的ARM指令。
* 2.Thumb状态：处理器执行16位、半字节对齐的Thumb指令

## 4.2 工作状态的切换
系统上电或复位处于ARM状态，可以与Thumb状态进行切换

* 进入Thumb状态
	1. 当操作数寄存器的状态位(0)为1时，可以采用执行BX指令的方法，使微处理器从ARM状态切换到Thumb状态
	2. 当处理器处于Thumb状态发生异常(IRQ,FIQ,Undef,Abort和SWI等)，则当异常处理返回时，自动切换到Thumb状态

```
;从ARM状态切换到Thumb状态
LDR R0,=Lable + 1
BX  R0
```

* 切换到ARM状态
	1. 当操作数寄存器的状态位为0时，执行BX指令可以使微处理器从Thumb状态切换到ARM状态。
	2. 处理器处理异常，把PC指针放入异常模式连接寄存器中，并从异常向量地址开始执行程序，也可以使处理器切换到ARM 状态

```
;从Thumb状态切换到ARM状态
LDR R0, =Lable
BX R0
```

## 4.3ARM微处理器的工作模式
### 4.3.1 ARM处理器模式类型
有7中模式：

* 1.用户模式(user):ARM正常程序状态，大部分执行在这种模式。
	* 
* 2.快速中断模式(fiq):当一个高优先级(fast)中断产生进入这种模式，用于高速数据传输或通道处理。
* 3.外部中断模式(irq):一个低优先级(normal)中断产生进入这种模式，用于通用中断处理
* 4.管理模式(svc):当复位或软中断指令执行时将进入这种模式，供系统使用一种保护模式
* 5.中止模式(abt):当存取异常时候进行这种模式，用于虚拟存储及存储保护
* 6.未定义模式(und):当执行未定义指令时进入这种模式，软件仿真硬件协处理器。
* 7.系统模式(svc):供需要访问系统资源的操作系统任务使用，运行具有特权的操作系统任务

### 4.3.2 模式特点

* 1.用户模式特点：应用程序不能访问受操作系统保护的系统资源，也不能进行模式的切换
* 2.系统模式特点：不属于异常模式，不是通过异常进入。系统模式属于特权模式，可以访问所有的系统资源，也可以直接进行模式切换。主要供系统使用。
* 3.特权模式及其特点：除用户模式之外的工作模式又称特权模式。应用程序可以访问所有的系统资源，可以任意地进行处理器模式的切换
* 4.异常模式及其特点：除用户模式、系统模式之外的5种模式成为异常模式。特点：以各自的中断或异常方式进入，并且处理各自的中断或异常。对管理模式(svc)进入方式和处理内容有：
	* 1.系统上电复位进入管理模式，运行系统初始化程序，如中断允许/禁止，主时钟设置，SRAM配置，各个功能模块初始化等。
	* 2.当执行软件中断SWI时，进入管理模式

### 4.3.3模式切换
当应用程序发生异常中断时，处理器进入相应的异常模式。**每一种异常模式下都有一组寄存器**，供相应的异常处理程序使用，这样可以保证在进入异常模式时，用户模式的寄存器不被破坏。处理器模式切换的方式:

* 软件控制切换
* 通过外部中断和异常进行切换

处理器启动时模式切换：

* **管理模式**：复位后的缺省模式
* **多种特权模式变换**：主要完成各模式的堆栈设置，注意不能进入用户模式。
* **用户程序的运行模式**：一般用户模式

系统模式不是通过异常进入的，和用户模式具有完成一样寄存器。这样避免异常发生时候，寄存器状态被破坏。但系统模式属于特权模式，可以访问所有的资源，也可以直接进行处理器模式切换。

## 4.4 ARM体系结构的存储格式
### 4.4.1 ARM存储数据类型
ARM处理器支持以下3种数据类型：

1. 8位有符号和无符号字节(byte)
2. 16位有符号和无符号半字(Halfword)，必须以两字节的边界对齐(即半字对齐)
3. 32位有符号和无符号(Word)，必须以4字节的边界对齐(字对齐)

字对齐：**字单元地址**的低两位A1A0 = 0b00。即地址末位0x0,0x4，0x8和0xa

半字对齐：**半字单元地址**的最低位A0 = 0b0(地址末位为0x0、0x2、0x4、0x6、0x8、0xa、0xc、0xe)

**指令**：ARM支持32位指令ARM和16位指令Thumb，存储时候分别以32位和16位的两种不同长度存储

**数据**:ARM支持32位字数据、16位半字数据、8位字节数据操作。因此存储器可以32、16和8位3种长度数据

在ARM内部，所有操作都面向32位的操作数，只有**数据传送指令**支持较短的字节和半字节数据。

当从存储器读取一字节或半字时，根据其数据类型扩展到32位。

### 4.4.2 ARM存储器组织
ARM存储器以8位为一个单元存储数据(1字节)，每个存储单元分配一个存储地址。ARM将存储器看作是从0地址开始的字节线性组织。作为32位的微处理器，ARM体系结构所支持最大寻址空间为4GB**字节**.

32位字数据要使用4个地址单元，16位半字数据要使用2个地址单元。这样存在一个所存储的字或半字数据的排列顺序问题。即大端格式和小端格式。

* 大端格式

字数据的高字节地址存储在低地址中，而字数据的低字节则存在高地址中

* 小端格式

与大端格式相反

#### 4.4.2.1指令长度及数据类型
ARM微处理器指令长度可以32位，也可以16位。ARM微处理器支持8位，半字16位，字32位类型。字需要4字节对齐(低2位为0)，半字需要2字节对齐(地址低位为0)

### 4.4.3 ARM存储层次
微处理器希望存储器容量大、速度快。但容量大者速度慢；速度快者容量小。方案采用多级存储组成的复合存储器系统。

#### 4.4.3.1 两级存储方案
一个容量小但速度快的从存储器和一个容量大但速度慢的主存储器。

宏观上看这个存储器系统像一个大又快的存储器。容量小但速度快的元件cache，自动保存处理器经常用到指令和数据拷贝.

#### 4.4.3.2 多级存储器系统
多级存储器系统：CPU-寄存器组-片上ARM-片上RAM-主存储器-硬盘

寄存器组：访问时间约为几个ns

片上ARM：与片外ARM比较，速度快、功耗低、容量小，读写时间约为几个ns

片上Cache：8~32KB，访问时间约为几十ns

主存储器：一般几兆字节~1GB的动态存储器，访问时间约为50ns
