# 1.寄存器组织
ARM共有37个32位寄存器，其中31个通用寄存器，6个为状态寄存器。这些寄存器不能被同时访问，具体访问能些根据当前处理器工作状态及具体运行模式。

但在任何时候，通用寄存器R0~R14、程序计数器PC、一个或两个状态寄存器都是可以直接访问的。

## 1.1 ARM状态下的寄存器组织
### 1.1.1 通用寄存器
通用寄存器R0~R15可分为3类：

* 1.R0~R7未分组寄存器

所有运行模式下，未分组寄存器都指向同一个物理寄存器，未被系统用作特殊用途的。注意：中断或异常处理进行运行模式转换时，不同处理器运行模式都是用相同的物理寄存器，可能造成寄存器中数据的破坏。

* 2.分组寄存器R8~R14

分组寄存器，每一次访问物理寄存器与处理器当前的运行模式有关。

* R8~R12:每个寄存器对应两个不同的物理寄存器，当使用fiq模式，访问寄存器R8_fiq~R12_fiq；除了fiq模式以外的其他模式时，访问寄存器R8_user~R12_user
* 对于R13、R14来说，每个寄存器对应6个不同的物理寄存器，其中一个用户模式与系统模式共用。另外5个物理寄存器对应于其他5个不同的运行模式：采用以下的记号来区分不同的物理寄存器：

R13_<mode>   R14_<mode>,其中mode以下几种模式之一：usr、fiq、irq、svc、abt、und

R13常用作为**堆栈指针**。每种模式都有独立物理独立寄存器R13,用户程序初始化，一般都要初始化每种模式下的R13,使其指向运行模式的栈空间.

* 当程序进入异常模式，可以将需要保护的寄存器放入R13所指向的堆栈，而程序从异常模式返回时，则从堆栈中恢复，采用这种方式保证异常发生后程序的正常执行。

R14作为**子程序连接寄存器**或连接寄存器LR。当执行BL子程序调用指令，R14中得到R15(程序计数器PC)的备份。其他作为通用寄存器使用。类似的发生中断或异常时，对应的分组寄存器R14_svc、R14_irq、R14_fiq、R14_abt和R14_und用来保存R15返回值。

R14用作为如下情况：

每种模式，都可用R14保存子程序返回地址，当BL或BLX指令调用字程序时，将PC的当前值复制给R14，执行完子程序后，又将R14的值复制回PC，即可完成子程序的调用返回。以上的描述可用指令完成：

执行以下任意一条指令：

```
MOV PC,LR
BX LR
```

在子程序入口使用以下指令将R14存取堆栈:`STMFD SP!,{<Regs>,LR}`

与之对应的，使用以下指令可以完成子程序返回:`LDMFD SP!,{<Regs>,PC}`

* 3.程序计数器PC（R15）

寄存器R15用作程序计数器(PC)。在ARM状态下[1:0]为0，位[31:2]用于保存PC；

由于ARM体系结构采用多级流水线技术，对于ARM指令集而言，PC总是指向当前指令的下两条指令的地址。即PC的值为当前指令的地址加8字节。

#### 1.1.2 寄存器R16
寄存器R16用作CPSR，当前程序状态寄存器，CPSR可在任何状态被访问。它包含条件标志、中断禁止位、当前处理器模式标志位，以及其他一些相关的控制和状态位。

每一种运行模式专用的物理寄存器，成为SPSR(备份的程序状态寄存器)，当异常发生时，SPSR用于保存CPSR的当前值，从异常推出时则可由SPSR来恢复CPSR。由于用户模式和系统模式不属于异常模式，它们没有SPSR，当在这两种模式访问SPSR，结果时未知的。

### 1.1.3 程序状态寄存器
ARM体系结构包含一个当前程序状态寄存器(CPSR)和5个备份的程序状态寄存器。备份的程序状态寄存器用来进行异常处理，其功能包含：

* 1.保存ALU中的当前操作信息
* 2.控制允许和禁止中断
* 3.设置处理器的运行模式

程序状态寄存器：

* `[0:4]`:Mode bits8
* `5`:State bit
* `6`:FIQ bit
* `7`:IRQ bit
* `28`:Overflow
* `29`:Carry/Brrow/Extend
* `30`:Zero
* `31`:Negative/Less than

#### 1.1.3.1 条件码标志
N、Z、C、V均为条件码标志。他们值可以被算术或者逻辑运算结果改变，并且决定某条件指令是否被执行。

在ARM状态下，绝大多数的指令都是有条件执行的。

#### 1.1.3.2 程序状态寄存器控制位
PSR低8位称为控制位，发生异常时这些位可以被改变。如果处理器运行特权模式，则这些位也可以由程序修改。

* 1.中断位I,F
	* I=1，禁止IRQ中断
	* F=1，禁止FIQ中断

# 2.异常
当正常程序执行流程发生暂停时，称之为异常。处理异常之前，当前处理器状态必须保存，这样当异常处理完成之后，当前程序可以继续执行。可以允许多个异常同时发生，将会按固定的优先级进行处理。
ARM具有7中异常模式

## 2.1 对应的异常响应

当一个异常出现以后，ARM微处理器会执行以下操作：

* 1.将下一条指令的地址存入相应连接寄存器LR。若ARM状态进入，LR会保留下一条指令地址(PC+4或PC+8,与异常类型有关）
* 2.将CPSR复制到相应SPSR中
* 3.根据异常类型，强制设置CPSR的运行模式
* 4.强制PC从相关异常向量地址取下一条指令执行，从而跳转到相应的异常处理程序处。

ARM微处理器对异常的相应过程用伪码可以描述为：

```
R14_<Exception_Mode> = Return Link
SPSR_<Exception_Mode> = CPSR
CPSR[4:0] = Exception Mode Number
CPSR[5] ] = 0 ; 当运行于ARM工作状态时
if<Exception Mode> == Reset or FIQ the;当响应FIQ异常时，禁止新的FIQ异常
CPSR[6] = 1 
CPSR[7] = 1
PC = Exception Vector Address ;异常向量地址
```

## 2.2 从异常返回
异常处理完成后，ARM微处理器会执行以下操作：

* 1.将链接寄存器LR的值减去相应的偏移量后送到PC中
* 2.将SPSR复制回CPSR中
* 3.若在异常处理中，设置了中断禁止位，要在此清除