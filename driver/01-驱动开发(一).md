## 驱动程序介绍
知识结构：
* 1.Linux驱动程序设计模式(40%)
* 2.内核相关知识(30%)
* 3.硬件相关知识(30%)

驱动分类:
* 字符设备驱动(重点)
* 网络接口驱动(重点)
* 块设备驱动

### 字符设备
字符设备是一种按字节来访问的设备，字符驱动则负责驱动字符设备，这样的驱动通常实现open,close,read和write系统调用。

### 块设备

大部分的`Unix系统`,块设备不能按字节处理数据，`只能一次传动一个或多个长度是512字节(或一个更大的2次幂的数)`的整块数据。

而`Linux`则允许块设备传送`任意数目字节`.因此，块和字符设备的区别仅仅是`驱动的与内核接口不同`

### 网络接口
任何网络事物都通过一个接口来进行，一个接口通常是一个硬件设备(eht0),但是它可以是一个村纯粹的软件设备，比如回环接口(lo)。一个网络接口负责发送和接收数据报文。

### 使用驱动程序
Linux用户程序通过`设备文件(设备节点)`来`使用驱动程序`操作`字符设备`和`块设备`

<center>
<image src="./image/01-01.jpg">
</center>

## 字符设备驱动程序
需要掌握1.设备号，2.创建设备文件，3.设备注册，4.重要数据结构，5.设备操作

#### 主次设备号
`字符设备`通过`字符设备文件`来存取。`ls -l`可查看`c`标识设备文件，逗号分开的为主次设备编号。

* `主设备号`用来`标识`与设备文件相连的驱动程序。次编号被驱动程序用来辨别操作的是哪个设备。**主设备号**反映设备类型，**次设备号**用来区分`同类型`的设备

* `dev_t设备号`，实质是unsigned int32位整数，其中高12位为主设备号，低20位为次设备号。
* 从`dev_t`中分解出设备号,`MAJOR(dev_t dev)`
* 从`dev_t`中分解出次设备号,`MINOR(dev_t dev)`

分配主设备号：可以采用`静态申请`，`动态分配`两种方法。
##### 静态申请

* 1.根据documentation/devices.txt，确定一个没有使用的主设备号
* 2.使用`register_chrdev_region`函数注册设备号。
	* 优点:简单
	* 缺点：一旦驱动被广泛使用，随机选定主设备可能会设备号冲突，而使驱动程序无法注册。
```
int register_chrdev_region(dev_t from,unsigned count,const char*name)
```
功能：申请使用从from开始的count个设备号(主设备号不变，次设备号增加)

参数：
* from希望申请使用的设备号
* count希望申请使用设备号数目
* name设备名(体现在/proc/devices)
#### 动态分配
`alloc_chrdev_region`分配设备号。优点：简单，易于驱动推广。
缺点：无法在安装驱动前创建设备文件(因为安装前还没有分配到主设备号)。 解决办法:安装驱动后从`/proc/devices`中查询设备号

```
int alloc_chrdev_region(dev_t*dev,unsigned baseminor,unsigned count,const char*name)
```
* 功能：请求内核动态分配count个设备号，且次设备号从baseminor开始
* 参数
	* dev：分配到的设备号
	* basemionor:起始次设备号
	* count：需要分配的设备号数目
	* name：设备名(体现在`/proc/devices`)
#### 注销设备号
不论使用那种方法分配设备号，都应该在不再使用它们时释放这些设备号。
```
void unregister_chrdev_region(dev_t from,unsigned count)
```
* 功能：释放从from开始的count个设备号

### 创建设备文件
两种方法：
* 1.使用`mknod`命令手工创建
mknod用法:`mknod filename type major minor`

	*	filename:设备文件名
	*	type设备文件类型
	*	major主设备号
	*	minor次设备号
`mknod serial0 c 100 0`
* 2.自动创建。

### 重要结构
Linux字符设备驱动程序设计中，有3个非常重要的数据结构:
```
struct file
struct inode
struct file_operations
```
* `struct file`代表一个打开的文件。系统中每个打开的文件内核空间都有一个关联的`struct file`，它由内核在打开时创建，在文件关闭后释放。重要成员:

	*	loff_t f_pos 文件读写位置
	*	struct file_operations *f_op
* `struct inode`用来记录文件的物理上信息。一个文件可多个file结构，但只有一个inode结构。
	* dev_t i_rdev设备号
## 字符驱动实例分析
## 驱动调试技术
## 并发控制